"use strict";var G=Object.create;var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var L=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var $=(s,e)=>{for(var r in e)U(s,r,{get:e[r],enumerable:!0})},B=(s,e,r,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of L(e))!Y.call(s,o)&&o!==r&&U(s,o,{get:()=>e[o],enumerable:!(t=K(e,o))||t.enumerable});return s};var g=(s,e,r)=>(r=s!=null?G(Q(s)):{},B(e||!s||!s.__esModule?U(r,"default",{value:s,enumerable:!0}):r,s)),ee=s=>B(U({},"__esModule",{value:!0}),s);var te={};$(te,{default:()=>re});module.exports=ee(te);var N=g(require("express"),1),H=g(require("cookie-parser"),1),X=require("zod");var V=require("express");var w=require("zod"),S=g(require("jsonwebtoken"),1);var ie=require("dotenv/config"),f=require("zod"),se=f.z.object({NODE_ENV:f.z.enum(["dev","test","production"]).default("dev"),PORT:f.z.coerce.number().default(3333),JWT_SECRET:f.z.string().min(20),JWT_EXPIRES_IN:f.z.coerce.number().default(900)}),v=se.safeParse(process.env);if(!v.success)throw console.error(v.error.format()),new Error("Invalid environment variable.");var u=v.data;var b=require("@prisma/client"),m=new b.PrismaClient({log:(u.NODE_ENV,["query"])});var ue=require("@prisma/client"),n=class{async findByName(e,r){let t=await m.user.findMany({where:{name:{contains:e,mode:"insensitive"}},take:20,skip:(r-1)*20});return t.length>0?t:null}async findById(e){return await m.user.findUnique({where:{id:e}})}async findByEmail(e){return await m.user.findUnique({where:{email:e}})}async create(e){return await m.user.create({data:e})}async delete(e){return await m.user.delete({where:{id:e}})}};var k=require("bcryptjs");var c=class extends Error{constructor(){super("Invalid credentials")}};var h=class{constructor(e){this.userRepository=e}async execute({email:e,password:r}){let t=await this.userRepository.findByEmail(e);if(!t)throw new c;if(!await(0,k.compare)(r,t.passwordHash))throw new c;return{user:t}}};function I(){let s=new n;return new h(s)}async function T(s,e){let r=w.z.object({email:w.z.email(),password:w.z.string().min(6)}),{email:t,password:o}=r.parse(s.body);try{let{user:i}=await I().execute({email:t,password:o}),a={subject:i.id,expiresIn:u.JWT_EXPIRES_IN},Z=S.default.sign({email:i.email,name:i.name},u.JWT_SECRET,a);return e.status(200).json({token:Z})}catch(i){if(i instanceof c)return e.status(409).json({message:i.message});throw i}}var l=require("zod");var _=require("bcryptjs");var d=class extends Error{constructor(){super("E-mail already exists")}};var x=class{constructor(e){this.userRepository=e}async execute({name:e,email:r,password:t}){let o=await(0,_.hash)(t,6);if(await this.userRepository.findByEmail(r))throw new d;return{user:await this.userRepository.create({name:e,email:r,passwordHash:o})}}};function D(){let s=new n;return new x(s)}async function W(s,e){let r=l.z.object({name:l.z.string(),email:l.z.email(),password:l.z.string().min(6)}),{name:t,email:o,password:i}=r.parse(s.body);try{await D().execute({name:t,email:o,password:i})}catch(a){if(a instanceof d)return e.status(409).send({message:a.message});throw a}return e.status(201).send()}async function F(s,e){let r=s.userId,t=await m.user.findUnique({where:{id:r},select:{id:!0,name:!0,email:!0,createdAt:!0}});return t?e.json({user:t}):e.status(404).json({message:"User not found"})}var E=require("zod");var C=class{constructor(e){this.userRepository=e}async execute({name:e,page:r}){return{user:await this.userRepository.findByName(e,r)??[]}}};function J(){let s=new n;return new C(s)}async function A(s,e){let r=E.z.object({name:E.z.string(),page:E.z.coerce.number()});try{let{name:t,page:o}=r.parse(s.query),a=await J().execute({name:t,page:o});return e.status(200).send(a)}catch(t){if(t instanceof Error)return e.status(409).send({message:t.message});throw t}return e.status(200).send()}var j=require("zod");var y=class extends Error{constructor(){super("user id does not exist")}};var P=class{constructor(e){this.userRepository=e}async execute({id:e}){let r=await this.userRepository.delete(e);if(!r)throw new y;return{user:r}}};function z(){let s=new n;return new P(s)}async function O(s,e){let r=j.z.object({id:j.z.uuid()}),{id:t}=r.parse(s.body);try{await z().execute({id:t})}catch(o){if(o instanceof y)return e.status(409).send({message:o.message});throw o}return e.status(201).send()}var M=g(require("jsonwebtoken"),1);function q(s,e,r){let t=s.header("authorization")||s.get("authorization");if(!t?.startsWith("Bearer "))return e.status(401).json({message:"Missing or invalid token"});let o=t.slice(7);try{let i=M.default.verify(o,u.JWT_SECRET);return i?.sub?(s.userId=i.sub,r()):e.status(401).json({message:"Token missing subject"})}catch{return e.status(401).json({message:"Token invalid or expired"})}}var p=(0,V.Router)();p.get("/health",(s,e)=>e.json({ok:!0}));p.post("/register",W);p.post("/login",T);p.get("/me",q,F);p.get("/find-person",q,A);p.delete("/",q,O);var R=(0,N.default)();R.use(N.default.json());R.use((0,H.default)());R.use(p);R.use((s,e,r,t)=>s instanceof X.ZodError?r.status(400).json({message:"Validation error.",issues:s.issues}):(process.env.NODE_ENV!=="production"&&console.error(s),r.status(500).json({message:"Internal server error."})));var re=R;
